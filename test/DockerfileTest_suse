# ==============================================================================================
# FILENAME	:	DockerfileTest
# AUTHOR	:	yanqi27
# CREATION	:	2023-03-22
# Dockerfile to test core analyzer against ptmalloc/tcmalloc/jemalloc
# Tested base images:
#   opensuse/leap:15.6, opensuse/leap:15.5
# ==============================================================================================

ARG VARIANT="opensuse/leap:15.6"

FROM ${VARIANT}

WORKDIR /workspaces/core_analyzer/
COPY . .

RUN ./test/setup_suse.sh
RUN python ./test/extra_setup.py

RUN echo 'set pagination off' > /root/.gdbinit

ARG GDB_VERSION=latest

RUN ./build_gdb.sh ${GDB_VERSION}
WORKDIR test
RUN make check

WORKDIR /workspaces/core_analyzer/
RUN ./build_jemalloc.sh 5.3.0
WORKDIR test
RUN make check-jemalloc

WORKDIR /workspaces/core_analyzer/
RUN ./build_jemalloc.sh 5.2.1
WORKDIR test
RUN make check-jemalloc

WORKDIR /workspaces/core_analyzer/
RUN ./build_jemalloc.sh 5.2.0
WORKDIR test
RUN make check-jemalloc

WORKDIR /workspaces/core_analyzer/
RUN ./build_tcmalloc.sh 2.16
WORKDIR test
RUN make check-tcmalloc

WORKDIR /workspaces/core_analyzer/
RUN ./build_tcmalloc.sh 2.15
WORKDIR test
RUN make check-tcmalloc

WORKDIR /workspaces/core_analyzer/
RUN ./build_tcmalloc.sh 2.14
WORKDIR test
RUN make check-tcmalloc
